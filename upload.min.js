!function(w,a){var e=function(e){var t,a=w(this);if(a.data("uploadinit"))return!1;var p,n,r,f,i=w.noop,o=0,d={},l={url:null,maxSize:5,auto:!0,multiple:!0,file:"file",separate:!1,allowExt:["jpg","jpeg","png","gif"],before:w.noop,success:w.noop,error:w.noop,onprogress:null,data:null,processbar:!1,action:null,dataType:"json",processContainer:null,startBtn:null,fileBox:null,always:w.noop,done:w.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};p=w.extend(l,e);var s=(268435456*(1+Math.random())|0).toString(16),u="uploadfile-"+s,c=p.multiple?' multiple="multiple" ':"";w("body").append('<input id="'+u+'" type="file" '+c+' style="display:none">');var v=w("#"+u);if(r=function(e){t=e.currentTarget,v.trigger("click")},p.fileBox){i=function(e){e.preventDefault(),e.stopPropagation()};var g=w(p.fileBox);g.length&&g.on("dragover dragenter",i).on("drop",function(e){e.originalEvent.dataTransfer&&0<e.originalEvent.dataTransfer.files.length&&(e.preventDefault(),e.stopPropagation(),m(e.originalEvent.dataTransfer.files))})}a.on("click",r),a.data("uploadinit",1),v.on("change",function(){if(0===o){var e=this.files;0<e.length&&m(e)}}),(f=(f=p.processContainer?w(p.processContainer):null)&&f.length?f:null)&&p.action&&f.on("click",".action-icon-"+s,p.action);var m=function(e){p.fd=new FormData;var t=[],i=[],o=1048576*p.maxSize,l=!1,s=!1,f=[];if(w.each(e,function(e,a){i.push(a),a.size>o&&(l=w.isFunction(p.sizeError)?{item:a,maxSize:p.maxSize}:a.name+p.sizeError.replace("XX",p.maxSize));var n=a.name.split(".");(n.length<2||w.inArray(n.pop().toLowerCase(),p.allowExt)<0)&&(s=w.isFunction(p.typeError)?{item:a,allowExt:p.allowExt}:a.name+p.typeError);var r=p.multiple?p.file+e:p.file;t.push(r),p.separate||p.fd.append(r,a),f.push({id:x(a),size:a.size})}),l)return w.isFunction(p.sizeError)?p.sizeError(l):alert(l);if(s)return w.isFunction(p.typeError)?p.typeError(s):alert(s);if(p.multiple&&p.fd.append("filelist",t),p.processbar&&z(e),p.auto){if(p.separate)return w.each(e,function(e,a){if(e=x(a),p.fd=new FormData,p.fd.append(p.file,a),!1!==p.before(p,e,a)){p.fd.append("data",JSON.stringify(p.data));var n=y(p.fd,[{id:e,size:a.size}],e,a);d[e]=n}}),v.val("");if(!1===p.before(p,e))return;return p.fd.append("data",JSON.stringify(p.data)),y(p.fd,f,null,i)}n&&w(p.startBtn).off("click",n),n=function(){return p.separate?(w.each(e,function(e,a){if(e=x(a),p.fd=new FormData,p.fd.append(p.file,a),!1!==p.before(p,e,a)){p.fd.append("data",JSON.stringify(p.data));var n=y(p.fd,[{id:e,size:a.size}],e,a);d[e]=n}}),v.val("")):!1!==p.before(p,e)?(p.fd.append("data",JSON.stringify(p.data)),y(p.fd,f,null,i)):void 0},w(p.startBtn).on("click",n)},y=function(e,l,s,r){p.separate||v.val("");var a={url:p.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:p.dataType,data:e,xhr:function(){var e=w.ajaxSettings.xhr();return e.upload.onprogress=function(e){var a=e.loaded;if(w.isFunction(p.onprogress)&&p.onprogress(Math.floor(a/e.total*100)+"%",e,l),f){if(s){var n=Math.floor(a/l[0].size*100)+"%";return f.find(".process-"+s+" i").stop(!0,!0).animate({width:n},400)}for(var r in l){var t=l[r],i=t.size;if(!(i<a)){var o=Math.floor(a/i*100)+"%";f.find(".process-"+t.id+" i").stop(!0,!0).animate({width:o},400);break}a-=i,f.find(".process-"+t.id+" i").stop(!0,!0).animate({width:"100%"},50)}}},e},success:function(e,a,n){p.success.call(t,e,a,n,r)},error:function(e,a,n){p.error.call(t,e,a,n,r)}},n=p.destroy?h:w.noop;return p.separate?(o++,w.ajax(a).always(p.always).always(function(){0==--o&&(n(),p.done())})):w.ajax(a).always(p.always).done(n).done(p.done)},h=function(){return v.remove(),a.off("click",r).data("uploadinit",0),w(p.startBtn).off("click",n),f&&f.empty()},z=function(e){var n=[],r=p.action?'<i class="action-icon action-icon-'+s+'"></i>':"";return w.each(e,function(e,a){a&&(e=x(a),n.push("<div data-id="+e+'><p class="filename file-'+e+'">'+a.name+"("+function(e){var a=0;for(;1204<=e;)e/=1024,a++;return e.toFixed(2)+" "+["B","KB","MB","GB","TB","PB"][a]}(a.size)+')</p><p class="processbar process-'+e+'"><i></i></p>'+r+"</div>"))}),f&&f.html(n.join(""))};return{destroy:h,input:v,button:a,clear:function(e){return e?f.find("[data-id="+e+"]").remove():f&&f.empty()},get:function(e){return d[e]},uid:x}};function x(e){return a.btoa(encodeURI(e.lastModified+e.name+e.size)).replace(/[^\w]+/g,"")}e.version="1.0",w.fn.uploadFile=e}(jQuery,window);